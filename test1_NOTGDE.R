library(ncdf4)
library(plspm)
library(ggplot2)
library(tidyr)
#"E:/ISIMIP/1CWatM/year126_NOTGDE_mean.nc"
#"E:/ISIMIP/4WaterGAP2/mean/year126_NOTGDE_mean.nc"
# 打开 NetCDF 文件
gwr_nc <- nc_open("E:/ISIMIP/1CWatM/mean/year126_NOTGDE_mean.nc")
gwr_nc <- ncvar_get(gwr_nc, "qr")
gwr_mean <- apply(gwr_nc,3,mean,na.rm=TRUE)

qs_nc <- nc_open("E:/ISIMIP/bios/qs/mean/year126_NOTGDE_mean.nc")
qs_nc <- ncvar_get(qs_nc, "qs")
qs_mean <- apply(qs_nc,3,mean,na.rm=TRUE)

snd_nc <- nc_open("E:/ISIMIP/bios/snd/mean/year126_NOTGDE_mean.nc")
snd_nc <- ncvar_get(snd_nc, "snd")
snd_mean <- apply(snd_nc,3,mean,na.rm=TRUE)

soilmoist_nc <- nc_open("E:/ISIMIP/bios/soilmoist/mean/year126_NOTGDE_mean.nc")
soilmoist_nc <- ncvar_get(soilmoist_nc, "soilmoist")
soilmoist_mean <- apply(soilmoist_nc,3,mean,na.rm=TRUE)

tmax_nc <- nc_open("E:/ISIMIP/bios/tasmax/mean/year126_NOTGDE_mean.nc")
tmax_nc <- ncvar_get(tmax_nc, "tasmax")
tmax_mean <- apply(tmax_nc,3,mean,na.rm=TRUE)

tmin_nc <- nc_open("E:/ISIMIP/bios/tasmin/mean/year126_NOTGDE_mean.nc")
tmin_nc <- ncvar_get(tmin_nc, "tasmin")
tmin_mean <- apply(tmin_nc,3,mean,na.rm=TRUE)

rlds_nc <- nc_open("E:/ISIMIP/bios/rlds/mean/year126_NOTGDE_mean.nc")
rlds_nc <- ncvar_get(rlds_nc, "rlds")
rlds_mean <- apply(rlds_nc,3,mean,na.rm=TRUE)

evap_nc <- nc_open("E:/ISIMIP/bios/evap/mean/year126_NOTGDE_mean.nc")
evap_nc <- ncvar_get(evap_nc, "evap")
evap_mean <- apply(evap_nc,3,mean,na.rm=TRUE)

lai_nc <- nc_open("E:/ISIMIP/bios/lai/mean/year126_NOTGDE_mean.nc")
lai_nc <- ncvar_get(lai_nc, "lai")
lai_mean <- apply(lai_nc,3,mean,na.rm=TRUE)

pr_nc <- nc_open("E:/ISIMIP/bios/pr/mean/year126_NOTGDE_mean.nc")
pr_nc <- ncvar_get(pr_nc, "pr")
pr_mean <- apply(pr_nc,3,mean,na.rm=TRUE)

ppl_nc <- nc_open("E:/ISIMIP/bios/population/ppl_NOTGDE_ssp126.nc")
ppl_nc <- ncvar_get(ppl_nc, "ppl")
ppl_mean <- apply(ppl_nc,3,mean,na.rm=TRUE)

gdp_nc <- nc_open("E:/ISIMIP/bios/population/gdp_NOTGDE_ssp126.nc")
gdp_nc <- ncvar_get(gdp_nc, "gdp")
gdp_mean <- apply(gdp_nc,3,mean,na.rm=TRUE)

# 126
#ppl_mean <- c(1.393797047,1.44830992,1.498719241,1.5751901,1.643276862,1.713922488,1.786863477,1.862196263,1.939854633,2.019779346,2.10191796,2.186210186,2.272601754,2.361040801,2.451480952,2.54388111,2.639684894,2.737302844,2.836521018,2.937130342,3.038926459,3.141971924,3.245811551,3.350240789,3.455058954,3.560069128,3.665016128,3.769928032,3.874778763,3.979545502,4.084208567,4.189140316,4.293952494,4.398631653,4.503166967,4.607550121,4.712964601,4.818267603,4.923457286,5.028533676,5.133498553,5.238943292,5.344304195,5.449591363,5.55481623,5.659991439,5.765580701,5.871001092,5.976115197,6.080786112,6.184877338,6.288465883,6.391214645,6.492999644,6.593696705,6.693181291,6.792892388,6.891409715,6.988774999,7.085029136,7.180212034,7.274590188,7.367991581,7.460461725,7.552044531,7.642782085,7.730411586,7.817086542,7.902757772,7.987373237,8.070877785,8.153628268,8.235155746,8.315393103,8.394268958,8.471707387,8.547926678,8.622545035,8.695470141,8.766603752,8.835841351,8.902773864,8.967581328,9.03013827,9.090311417,9.147959261)
#gdp_mean <- c(0.105292867,0.10622603,0.107133575,0.10801483,0.10886912,0.109695773,0.110494457,0.111266202,0.112012389,0.112734384,0.113433566,0.114111156,0.114767779,0.115403906,0.116020012,0.116616568,0.117193907,0.117751789,0.118289833,0.118807656,0.11930488,0.119780988,0.120234936,0.120665546,0.121071638,0.121452036,0.121805707,0.122132209,0.122431253,0.122702539,0.122945776,0.12316077,0.123347752,0.123507047,0.123638983,0.123743886,0.123822081,0.123873875,0.12389957,0.123899468,0.123873869,0.123823103,0.123747597,0.123647812,0.123524198,0.123377214,0.123207326,0.123015054,0.122800928,0.122565479,0.122309238,0.122032746,0.121736608,0.121421439,0.121087856,0.120736475,0.120367736,0.119981371,0.119576937,0.11915399,0.118712087,0.118250481,0.117767208,0.117260005,0.116726606,0.116164747,0.115573157,0.114954552,0.114312643,0.113651142,0.11297376,0.112283855,0.111583355,0.110873839,0.110156879,0.109434055,0.108706646,0.107974763,0.107238218,0.106496826,0.105750401,0.104998757,0.104241708,0.103479065,0.102710643,0.101936255)
# 585
#gdp_mean <- c(1.384807219,1.440017331,1.500668484,1.572426803,1.643688246,1.718792963,1.797615407,1.880384765,1.96715943,2.057999689,2.152967938,2.252097028,2.35544585,2.463062421,2.574996382,2.691299129,2.813491599,2.939910957,3.070257011,3.204232196,3.341541612,3.482259841,3.625743852,3.771695786,3.919820382,4.069825063,4.221494125,4.374774897,4.529682245,4.686233955,4.844450766,5.004895956,5.167083516,5.331044297,5.496812051,5.6644234,5.83544289,6.008427746,6.183399566,6.360382434,6.539402849,6.721422709,6.905607667,7.091998273,7.280637339,7.471569786,7.665540366,7.861751083,8.060064053,8.2603429,8.462452578,8.66660053,8.872338117,9.07953816,9.288073972,9.497819185,9.710924742,9.925295288,10.14099027,10.35806816,10.57658603,10.79731107,11.01964456,11.24365405,11.46940507,11.69696071,11.92328715,12.15124964,12.38078699,12.61183223,12.84431192,13.07952917,13.31607937,13.55387117,13.79280472,14.03277081,14.27449019,14.51703385,14.76026101,15.00401743,15.24813431,15.49242004,15.73669212,15.9807317,16.22430043,16.46713895)
#ppl_mean <- c(0.105328004,0.106276066,0.107200859,0.108101588,0.10897746,0.109827684,0.110651811,0.111450758,0.112225796,0.11297818,0.113709179,0.114419899,0.115110828,0.115782299,0.116434644,0.117068195,0.11768319,0.118279478,0.118856812,0.119414946,0.119953632,0.120472492,0.120970608,0.121446929,0.121900402,0.122329978,0.122734736,0.123114289,0.123468383,0.12379676,0.124099165,0.124375443,0.124625863,0.124850788,0.125050585,0.125225618,0.125376229,0.125502656,0.125605109,0.1256838,0.125738942,0.12577077,0.125779623,0.125765871,0.125729875,0.125672002,0.125592648,0.125492344,0.125371646,0.125231113,0.125071302,0.124892785,0.124696193,0.124482171,0.124251363,0.124004411,0.12374178,0.123463216,0.123168284,0.122856549,0.122527576,0.122180628,0.121813747,0.121424673,0.121011148,0.120570912,0.120102692,0.119609146,0.119093917,0.118560646,0.118012974,0.117454183,0.11688612,0.116310272,0.115728124,0.115141161,0.11455058,0.113956411,0.113358398,0.11275628,0.112149802,0.111538703,0.110922725,0.110301612,0.109675104,0.109042943)
#co2
co2 <- c(399.95, 403.12, 405.75, 408.59, 411.42, 414.23, 417.04, 419.81, 422.5, 425.12, 427.67, 430.17, 432.6, 434.97, 437.29, 439.56, 441.78, 443.93, 445.99, 447.97, 449.87, 451.68, 453.43, 455.09, 456.68, 458.2, 459.65, 461.02, 462.31, 463.54, 464.68, 465.75, 466.75, 467.68, 468.53, 469.31, 470.02, 470.66, 471.25, 471.78, 472.25, 472.66, 473.02, 473.32, 473.56, 473.75, 473.88, 473.96, 474.0, 474.0, 473.96, 473.87, 473.75, 473.58, 473.36, 473.11, 472.81, 472.46, 472.04, 471.56, 471.02, 470.41, 469.75, 469.02, 468.24, 467.39, 466.48, 465.54, 464.56, 463.56, 462.53, 461.47, 460.38, 459.26, 458.1, 456.92, 455.71, 454.5, 453.32, 452.16, 451.02, 449.91, 448.81, 447.73, 446.67, 445.62)
#
fbnf_nc <- nc_open("E:/ISIMIP/bios/fbnf/mean/year126_NOTGDE_mean.nc")
fbnf_nc <- ncvar_get(fbnf_nc, "fbnf")
fbnf_mean <- apply(fbnf_nc,3,mean,na.rm=TRUE)

# 生成模拟数据（标准化数据）
data <- data.frame(
  gwr       = gwr_mean,
  qs        = qs_mean,
  snd       = snd_mean,
  soilmoist = soilmoist_mean,
  tmax      = tmax_mean,
  tmin      = tmin_mean,
  rlds      = rlds_mean,
  evap      = evap_mean,
  lai       = lai_mean,
  ppl       = ppl_mean,
  gdp       = gdp_mean,
  pr        = pr_mean,
  co2       = co2,
  fbnf      = fbnf_mean
)
# 义路径矩阵（下三角矩阵）
path_matrix <- rbind(
  c(0, 0, 0, 0, 0),  # HA
  c(1, 0, 0, 0, 0),  # CT
  c(1, 1, 0, 0, 0),  # HY
  c(1, 1, 1, 0, 0),  # VG
  c(1, 1, 1, 1, 0)   # Fbnf 受 HY、CT、HA、VG 影响
)
colnames(path_matrix) <- rownames(path_matrix) <- c("HA", "CT", "HY", "VG", "Fbnf")
# 义测量模型（block 指定哪些观测变量对应哪个潜变量）
blocks <- list(
  c("ppl", "gdp", "co2"),                   # HA
  c("tmax", "tmin", "rlds", "evap", "pr"), # CT
  c("gwr", "qs", "soilmoist", "snd"),       # HY
  c("lai"),                           # VG
  c("fbnf")                           # Fbnf
)

# 定反映性测量模式（"A" 代表反映性）
modes <- c("B", "B", "B", "A", "A")
# 运行 PLS-SEM
pls_model <- plspm(data, path_matrix, blocks, modes = modes)
# 输出结果
print(summary(pls_model))   # 模型摘要

# 添加索引列
data$index <- 1:86
# 转换为长格式
data_long <- pivot_longer(data, cols = -index, names_to = "variable", values_to = "value")
# 绘制曲线
ggplot(data_long, aes(x = index, y = value, color = variable)) +
  geom_line() +
  facet_wrap(~variable, scales = "free_y", ncol = 3) +
  labs(title = "14个变量的变化曲线（分面显示）", 
       x = "Index (1-86)", 
       y = "Value") +
  theme_minimal() +
  theme(legend.position = "none")  # 分面显示时可以去掉图例

